<% content_for :head do %>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css" rel="stylesheet">
<% end %>

<% calendar_events_json = @calendar_events.to_json %>

<div class="row g-3">
  <div class="col-12">
    <div class="card shadow-sm app-header-card">
      <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-3">
        <div>
          <h1 class="h4 mb-1 text-white">AJANDA</h1>
          <p class="text-secondary mb-0">Etkinlik Planlama ve Takibi</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 app-header-actions">
          <%= home_nav_button(home_path, label: "Ana Sayfa", icon: "home", class_name: "app-header-icon-btn") %>
          <%= link_to logout_path,
                      class: "rt-icon-btn app-header-icon-btn text-danger",
                      title: "Uygulamayı Kapat",
                      aria: { label: "Uygulamayı Kapat" },
                      data: { tip: "Uygulamayı Kapat", turbo_method: :delete, turbo_confirm: "Oturumu kapatmak istiyor musunuz?" } do %>
            <span class="material-symbols-outlined" aria-hidden="true">power_settings_new</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body p-3">
        <div class="row g-3">
          <div class="col-12 col-xl-9">
            <div class="agenda-card agenda-calendar-wrap">
              <div id="agenda-calendar"></div>
            </div>
          </div>

          <div class="col-12 col-xl-3">
            <div class="agenda-right-stack">
              <div class="agenda-card p-3">
                <% if current_user && Roles.catalog_manage?(current_user.role) %>
                  <button type="button" class="agenda-add-event" id="agenda-open-modal">Ajanda'na Not Ekle</button>
                <% else %>
                  <span class="agenda-add-event opacity-75">Etkinlik</span>
                <% end %>
              </div>

              <% if @agenda_items.present? %>
                <% @agenda_items.each do |item| %>
                  <div class="agenda-side-card <%= item[:theme_class] %>">
                    <article class="agenda-side-event">
                      <div class="agenda-date-pill">
                        <strong><%= item[:day] %></strong>
                        <span><%= item[:month] %></span>
                        <span><%= item[:year] %></span>
                      </div>
                      <div>
                        <h2 class="agenda-event-title"><%= item[:title] %></h2>
                        <p class="agenda-event-text"><%= item[:text] %></p>
                        <p class="agenda-event-meta"><%= item[:meta] %></p>
                        <% if current_user && Roles.catalog_manage?(current_user.role) %>
                          <div class="agenda-side-actions">
                            <button
                              type="button"
                              class="agenda-side-action-btn"
                              data-agenda-edit-event="1"
                              data-event-id="<%= item[:id] %>"
                              data-event-date="<%= item[:event_date_value] %>"
                              data-event-time="<%= item[:event_time_value] %>"
                              data-event-title="<%= item[:title] %>"
                              data-event-description="<%= item[:description_value] %>"
                              data-event-color="<%= item[:color_value] %>"
                              data-event-remind="<%= item[:remind_minutes_before] %>">Duzenle</button>
                            <%= button_to "Sil",
                                          calendar_event_path(item[:id]),
                                          method: :delete,
                                          form: { data: { turbo_confirm: "Bu etkinligi silmek istiyor musunuz?" } },
                                          class: "agenda-side-action-btn" %>
                          </div>
                        <% end %>
                      </div>
                    </article>
                  </div>
                <% end %>
              <% else %>
                <div class="agenda-side-card">
                  <p class="agenda-empty">Gosterilecek ajanda kaydi bulunamadi.</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if current_user && Roles.catalog_manage?(current_user.role) %>
  <div class="agenda-modal-backdrop" id="agenda-event-modal" aria-hidden="true">
    <div class="agenda-modal" role="dialog" aria-modal="true" aria-labelledby="agenda-modal-title">
      <h2 id="agenda-modal-title">Add Event</h2>
      <%= form_with url: calendar_events_path, method: :post, scope: :calendar_event, local: true, html: { id: "agenda-event-form" } do |f| %>
        <input type="hidden" name="_method" id="agenda-event-form-method" value="post">
        <div class="mb-3">
          <%= f.date_field :event_date, id: "agenda-event-date", class: "form-control", required: true, value: Date.current.iso8601 %>
        </div>
        <div class="mb-3">
          <%= f.time_field :event_time, id: "agenda-event-time", class: "form-control", required: true, value: "09:00" %>
        </div>
        <div class="mb-3">
          <%= f.text_field :title, id: "agenda-event-title-input", class: "form-control", required: true, maxlength: 160, placeholder: "Event Title" %>
        </div>
        <div class="mb-3">
          <%= f.text_area :description, id: "agenda-event-description", class: "form-control", maxlength: 1000, placeholder: "Event Description..." %>
        </div>
        <div class="mb-3">
          <%= f.select :remind_minutes_before,
                       options_for_select([["Alarm yok", 0], ["5 dk once", 5], ["10 dk once", 10], ["15 dk once", 15], ["30 dk once", 30], ["1 saat once", 60]], 10),
                       { id: "agenda-event-remind" },
                       class: "form-select" %>
        </div>
        <div class="mb-3">
          <%= f.hidden_field :color, id: "agenda-event-color", value: "#38bdf8" %>
        </div>
        <div class="agenda-modal-footer">
          <button type="submit" class="agenda-modal-btn is-primary" id="agenda-event-submit-label">Add</button>
          <button type="button" class="agenda-modal-btn" id="agenda-close-modal">Close</button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script id="agenda-events-json" type="application/json"><%= raw(json_escape(calendar_events_json)) %></script>
<script>
  let agendaCalendar = null
  const fullCalendarCdnUrl = "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"
  let agendaCalendarInitPending = false

  const ensureAgendaCalendarLibrary = (onReady) => {
    if (window.FullCalendar) {
      onReady()
      return
    }

    const existingScript = document.querySelector("script[data-agenda-fullcalendar='1']")
    if (existingScript) {
      if (existingScript.dataset.loaded === "1") {
        onReady()
        return
      }
      existingScript.addEventListener("load", onReady, { once: true })
      existingScript.addEventListener("error", () => { agendaCalendarInitPending = false }, { once: true })
      return
    }

    const script = document.createElement("script")
    script.src = fullCalendarCdnUrl
    script.async = true
    script.dataset.agendaFullcalendar = "1"
    script.addEventListener("load", () => {
      script.dataset.loaded = "1"
      onReady()
    }, { once: true })
    script.addEventListener("error", () => {
      agendaCalendarInitPending = false
    }, { once: true })
    document.head.appendChild(script)
  }

  const initAgendaCalendar = () => {
    if (!window.FullCalendar) {
      if (!agendaCalendarInitPending) {
        agendaCalendarInitPending = true
        ensureAgendaCalendarLibrary(() => {
          agendaCalendarInitPending = false
          initAgendaCalendar()
        })
      }
      return
    }

    const modal = document.getElementById("agenda-event-modal")
    const openBtn = document.getElementById("agenda-open-modal")
    const closeBtn = document.getElementById("agenda-close-modal")
    const form = document.getElementById("agenda-event-form")
    const formMethod = document.getElementById("agenda-event-form-method")
    const submitLabel = document.getElementById("agenda-event-submit-label")
    const inputDate = document.getElementById("agenda-event-date")
    const inputTime = document.getElementById("agenda-event-time")
    const inputTitle = document.getElementById("agenda-event-title-input")
    const inputDescription = document.getElementById("agenda-event-description")
    const inputColor = document.getElementById("agenda-event-color")
    const inputRemind = document.getElementById("agenda-event-remind")

    const resetModalForm = () => {
      if (!form) return
      form.action = "<%= calendar_events_path %>"
      if (formMethod) formMethod.value = "post"
      if (submitLabel) submitLabel.textContent = "Add"
      if (inputDate) inputDate.value = "<%= Date.current.iso8601 %>"
      if (inputTime) inputTime.value = "09:00"
      if (inputTitle) inputTitle.value = ""
      if (inputDescription) inputDescription.value = ""
      if (inputColor) inputColor.value = "#38bdf8"
      if (inputRemind) inputRemind.value = "10"
    }

    const openModalForCreate = () => {
      resetModalForm()
      if (!modal) return
      modal.classList.add("is-open")
      modal.setAttribute("aria-hidden", "false")
    }

    const openModalForEdit = (payload) => {
      if (!form || !payload || !payload.id) return

      form.action = "/calendar_events/" + payload.id
      if (formMethod) formMethod.value = "patch"
      if (submitLabel) submitLabel.textContent = "Update"
      if (inputDate) inputDate.value = payload.eventDate || "<%= Date.current.iso8601 %>"
      if (inputTime) inputTime.value = payload.eventTime || "09:00"
      if (inputTitle) inputTitle.value = payload.title || ""
      if (inputDescription) inputDescription.value = payload.description || ""
      if (inputColor) inputColor.value = payload.color || "#38bdf8"
      if (inputRemind) inputRemind.value = String(payload.remind || 0)

      if (!modal) return
      modal.classList.add("is-open")
      modal.setAttribute("aria-hidden", "false")
    }

    if (modal && openBtn && closeBtn && modal.dataset.bindReady !== "1") {
      const closeModal = () => {
        modal.classList.remove("is-open")
        modal.setAttribute("aria-hidden", "true")
      }

      modal.dataset.bindReady = "1"
      openBtn.addEventListener("click", openModalForCreate)
      closeBtn.addEventListener("click", closeModal)
      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal()
      })
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeModal()
      })
    }

    if (modal && !modal.dataset.editBindReady) {
      document.querySelectorAll("[data-agenda-edit-event='1']").forEach((btn) => {
        btn.addEventListener("click", () => {
          openModalForEdit({
            id: btn.dataset.eventId,
            eventDate: btn.dataset.eventDate,
            eventTime: btn.dataset.eventTime,
            title: btn.dataset.eventTitle,
            description: btn.dataset.eventDescription,
            color: btn.dataset.eventColor,
            remind: btn.dataset.eventRemind
          })
        })
      })
      modal.dataset.editBindReady = "1"
    }

    const calendarEl = document.getElementById("agenda-calendar")
    if (!calendarEl || !window.FullCalendar) return

    if (agendaCalendar) {
      agendaCalendar.destroy()
      agendaCalendar = null
    }

    const eventsEl = document.getElementById("agenda-events-json")
    const events = eventsEl ? JSON.parse(eventsEl.textContent || "[]") : []

    agendaCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      aspectRatio: 2.35,
      height: "auto",
      contentHeight: "auto",
      expandRows: true,
      displayEventTime: true,
      eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
      },
      buttonText: {
        today: "today",
        month: "month",
        week: "week",
        day: "day",
        list: "list"
      },
      firstDay: 1,
      fixedWeekCount: true,
      dayMaxEvents: 2,
      events: events,
      eventClick: (info) => {
        const start = info.event.start
        if (!start) return

        const yyyy = start.getFullYear()
        const mm = String(start.getMonth() + 1).padStart(2, "0")
        const dd = String(start.getDate()).padStart(2, "0")
        const hh = String(start.getHours()).padStart(2, "0")
        const mi = String(start.getMinutes()).padStart(2, "0")

        openModalForEdit({
          id: info.event.id,
          eventDate: `${yyyy}-${mm}-${dd}`,
          eventTime: `${hh}:${mi}`,
          title: info.event.title,
          description: info.event.extendedProps.description || "",
          color: info.event.backgroundColor || "#38bdf8",
          remind: info.event.extendedProps.remindMinutesBefore || 0
        })
      }
    })

    agendaCalendar.render()
    setTimeout(() => agendaCalendar && agendaCalendar.updateSize(), 0)
  }

  document.addEventListener("turbo:load", initAgendaCalendar)
  document.addEventListener("turbo:render", initAgendaCalendar)
  document.addEventListener("turbo:before-cache", () => {
    if (agendaCalendar) {
      agendaCalendar.destroy()
      agendaCalendar = null
    }
  })
</script>
