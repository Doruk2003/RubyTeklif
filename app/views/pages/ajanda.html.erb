<% content_for :head do %>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css" rel="stylesheet">
<% end %>

<% calendar_events_json = @calendar_events.to_json %>

<div class="container-fluid py-2">
  <style>
    .agenda-page-title {
      margin: 0 0 2px;
      font-size: 1.5rem;
      font-weight: 600;
      color: #fff;
    }

    .agenda-page-subtitle {
      margin: 0;
      color: rgba(255, 255, 255, 0.75);
      font-size: 0.95rem;
    }

    .agenda-top-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .agenda-top-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      border: 0;
      background: transparent;
      color: #cbd5e1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: color 120ms ease;
    }

    .agenda-top-icon-btn:hover {
      color: #fff;
      background: transparent;
    }

    .agenda-top-icon-btn .material-symbols-outlined {
      font-size: 24px;
      line-height: 1;
      font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
    }

    .agenda-top-icon-btn.is-power {
      color: #ff8a8a;
    }

    .agenda-top-icon-btn.is-power:hover {
      color: #ffb4b4;
    }

    .agenda-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 18px -14px rgba(15, 23, 42, 0.4);
    }

    .agenda-calendar-wrap {
      padding: 16px;
      min-height: 700px;
    }

    .agenda-right-stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .agenda-add-event {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #39a4ef;
      color: #fff;
      border: 0;
      border-radius: 999px;
      min-width: 116px;
      height: 40px;
      padding: 0 22px;
      font-weight: 600;
      text-decoration: none;
    }

    .agenda-add-event:hover {
      background: #1f8fe0;
      color: #fff;
    }

    .agenda-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      padding: 16px;
    }

    .agenda-modal-backdrop.is-open {
      display: flex;
    }

    .agenda-modal {
      width: min(560px, 100%);
      border-radius: 12px;
      border: 1px solid #d5dbe5;
      background: #fff;
      box-shadow: 0 24px 60px -30px rgba(15, 23, 42, 0.6);
      padding: 22px;
    }

    .agenda-modal h2 {
      margin: 0 0 16px;
      font-size: 30px;
      color: #334155;
      font-weight: 600;
    }

    .agenda-modal .form-control {
      border-radius: 999px;
      background: #f8fafc;
      border-color: #d3dbe8;
      font-size: 14px;
    }

    .agenda-modal .form-select {
      border-radius: 999px;
      background: #f8fafc;
      border-color: #d3dbe8;
      font-size: 14px;
    }

    .agenda-modal textarea.form-control {
      border-radius: 16px;
      min-height: 110px;
      resize: vertical;
    }

    .agenda-modal-footer {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .agenda-modal-btn {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #475569;
      border-radius: 999px;
      min-width: 98px;
      height: 40px;
      font-weight: 600;
    }

    .agenda-modal-btn.is-primary {
      border-color: #111827;
      background: #1f2937;
      color: #fff;
    }

    .agenda-side-card {
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #fff;
      padding: 14px 16px;
    }

    .agenda-side-event {
      display: flex;
      gap: 12px;
      padding: 6px 0;
    }

    .agenda-side-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .agenda-side-action-btn {
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      height: 30px;
      padding: 0 12px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .agenda-side-action-btn:hover {
      background: rgba(255, 255, 255, 0.28);
      color: #fff;
    }

    .agenda-date-pill {
      width: 66px;
      flex: 0 0 66px;
      text-align: center;
      color: #475569;
    }

    .agenda-date-pill strong {
      display: block;
      font-size: 34px;
      line-height: 1;
      font-weight: 500;
    }

    .agenda-date-pill span {
      display: block;
      font-size: 13px;
      line-height: 1.2;
    }

    .agenda-event-title {
      margin: 0 0 2px;
      font-size: 16px;
      line-height: 1.2;
      color: #334155;
      font-weight: 600;
    }

    .agenda-event-text {
      margin: 0 0 4px;
      color: #5b677a;
      font-size: 14px;
      line-height: 1.4;
    }

    .agenda-event-meta {
      margin: 0;
      color: #64748b;
      font-size: 13px;
      line-height: 1.3;
    }

    .agenda-side-card.is-blue {
      background: linear-gradient(120deg, #66b3f0, #64d7e7);
      border-color: transparent;
    }

    .agenda-side-card.is-green {
      background: linear-gradient(120deg, #8ad58d, #b7e86f);
      border-color: transparent;
    }

    .agenda-side-card.is-red {
      background: linear-gradient(120deg, #f69494, #f97373);
      border-color: transparent;
    }

    .agenda-side-card.is-blue .agenda-event-title,
    .agenda-side-card.is-blue .agenda-event-text,
    .agenda-side-card.is-blue .agenda-event-meta,
    .agenda-side-card.is-blue .agenda-date-pill,
    .agenda-side-card.is-green .agenda-event-title,
    .agenda-side-card.is-green .agenda-event-text,
    .agenda-side-card.is-green .agenda-event-meta,
    .agenda-side-card.is-green .agenda-date-pill,
    .agenda-side-card.is-red .agenda-event-title,
    .agenda-side-card.is-red .agenda-event-text,
    .agenda-side-card.is-red .agenda-event-meta,
    .agenda-side-card.is-red .agenda-date-pill {
      color: #fff;
    }

    .agenda-calendar-wrap .fc .fc-toolbar.fc-header-toolbar {
      margin-bottom: 10px;
    }

    .agenda-calendar-wrap .fc .fc-view-harness {
      margin-top: 8px;
    }

    /* Isolate FullCalendar from global table styles */
    .agenda-calendar-wrap .fc table {
      width: 100% !important;
      border-collapse: separate !important;
    }

    .agenda-calendar-wrap .fc .fc-scrollgrid,
    .agenda-calendar-wrap .fc .fc-scrollgrid table,
    .agenda-calendar-wrap .fc-theme-standard td,
    .agenda-calendar-wrap .fc-theme-standard th {
      border-color: #cfd8e3 !important;
    }

    .agenda-calendar-wrap .fc thead tr::after,
    .agenda-calendar-wrap .fc tbody tr::after {
      display: none !important;
      content: none !important;
    }

    .agenda-calendar-wrap .fc thead th,
    .agenda-calendar-wrap .fc tbody td {
      height: auto !important;
      padding: 0 !important;
      text-transform: none !important;
      letter-spacing: normal !important;
      background: transparent !important;
    }

    .agenda-calendar-wrap .fc tbody tr:hover td {
      background: transparent !important;
    }

    .agenda-calendar-wrap .fc .fc-toolbar-title {
      font-size: 22px;
      font-weight: 600;
      color: #334155;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .agenda-calendar-wrap .fc .fc-button {
      border-radius: 999px;
      border: 0;
      background: #e5e7eb;
      color: #334155;
      text-transform: lowercase;
      font-size: 14px;
      padding: 8px 14px;
      box-shadow: none;
    }

    .agenda-calendar-wrap .fc .fc-button:hover,
    .agenda-calendar-wrap .fc .fc-button:focus {
      background: #d5dae1;
      color: #1f2937;
      box-shadow: none;
    }

    .agenda-calendar-wrap .fc .fc-button.fc-button-active {
      background: #1e293b;
      color: #fff;
    }

    .agenda-calendar-wrap .fc .fc-daygrid-day-number {
      color: #475569;
      font-size: 14px;
      text-decoration: none;
    }

    .agenda-calendar-wrap .fc .fc-daygrid-day-frame {
      min-height: 90px;
    }

    .agenda-calendar-wrap .fc .fc-scroller,
    .agenda-calendar-wrap .fc .fc-scroller-liquid-absolute {
      overflow-y: hidden !important;
    }

    .agenda-calendar-wrap .fc .fc-col-header-cell-cushion {
      color: #334155;
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      padding: 12px 4px;
      text-transform: capitalize;
    }

    .agenda-calendar-wrap .fc .fc-daygrid-event {
      border: 0;
      border-radius: 3px;
      padding: 2px 4px;
      font-size: 12px;
    }

    .agenda-calendar-wrap .fc .fc-day-other .fc-daygrid-day-number {
      color: #c0c7d2;
    }

    .agenda-empty {
      margin: 0;
      font-size: 14px;
      color: #64748b;
    }

    @media (max-width: 991.98px) {
      .agenda-top-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>

  <div class="row g-2">
    <div class="col-12">
      <div class="card shadow-sm mb-3 w-100 rounded-0 bg-dark text-white" data-bs-theme="dark">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
          <div>
            <h1 class="agenda-page-title">AJANDA</h1>
            <p class="agenda-page-subtitle">Etkinlik Planlama ve Takibi</p>
          </div>
          <div class="agenda-top-actions">
            <%= link_to home_path,
                        class: "rt-icon-btn agenda-top-icon-btn",
                        title: "Ana Sayfa",
                        aria: { label: "Ana Sayfa" },
                        data: { tip: "Ana Sayfa" } do %>
              <span class="material-symbols-outlined" aria-hidden="true">home</span>
            <% end %>
            <%= link_to logout_path,
                        class: "rt-icon-btn agenda-top-icon-btn is-power",
                        title: "Uygulamayı Kapat",
                        aria: { label: "Uygulamayı Kapat" },
                        data: { tip: "Uygulamayı Kapat", turbo_method: :delete, turbo_confirm: "Oturumu kapatmak istiyor musunuz?" } do %>
              <span class="material-symbols-outlined" aria-hidden="true">power_settings_new</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-3">
          <div class="row g-3">
            <div class="col-12 col-xl-9">
              <div class="agenda-card agenda-calendar-wrap">
                <div id="agenda-calendar"></div>
              </div>
            </div>

            <div class="col-12 col-xl-3">
              <div class="agenda-right-stack">
                <div class="agenda-card p-3">
                  <% if current_user && Roles.catalog_manage?(current_user.role) %>
                    <button type="button" class="agenda-add-event" id="agenda-open-modal">Ajanda'na Not Ekle</button>
                  <% else %>
                    <span class="agenda-add-event opacity-75">Etkinlik</span>
                  <% end %>
                </div>

                <% if @agenda_items.present? %>
                  <% @agenda_items.each do |item| %>
                    <div class="agenda-side-card <%= item[:theme_class] %>">
                      <article class="agenda-side-event">
                        <div class="agenda-date-pill">
                          <strong><%= item[:day] %></strong>
                          <span><%= item[:month] %></span>
                          <span><%= item[:year] %></span>
                        </div>
                        <div>
                          <h2 class="agenda-event-title"><%= item[:title] %></h2>
                          <p class="agenda-event-text"><%= item[:text] %></p>
                          <p class="agenda-event-meta"><%= item[:meta] %></p>
                          <% if current_user && Roles.catalog_manage?(current_user.role) %>
                            <div class="agenda-side-actions">
                              <button
                                type="button"
                                class="agenda-side-action-btn"
                                data-agenda-edit-event="1"
                                data-event-id="<%= item[:id] %>"
                                data-event-date="<%= item[:event_date_value] %>"
                                data-event-time="<%= item[:event_time_value] %>"
                                data-event-title="<%= item[:title] %>"
                                data-event-description="<%= item[:description_value] %>"
                                data-event-color="<%= item[:color_value] %>"
                                data-event-remind="<%= item[:remind_minutes_before] %>">Duzenle</button>
                              <%= button_to "Sil",
                                            calendar_event_path(item[:id]),
                                            method: :delete,
                                            form: { data: { turbo_confirm: "Bu etkinligi silmek istiyor musunuz?" } },
                                            class: "agenda-side-action-btn" %>
                            </div>
                          <% end %>
                        </div>
                      </article>
                    </div>
                  <% end %>
                <% else %>
                  <div class="agenda-side-card">
                    <p class="agenda-empty">Gosterilecek ajanda kaydi bulunamadi.</p>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if current_user && Roles.catalog_manage?(current_user.role) %>
  <div class="agenda-modal-backdrop" id="agenda-event-modal" aria-hidden="true">
    <div class="agenda-modal" role="dialog" aria-modal="true" aria-labelledby="agenda-modal-title">
      <h2 id="agenda-modal-title">Add Event</h2>
      <%= form_with url: calendar_events_path, method: :post, scope: :calendar_event, local: true, html: { id: "agenda-event-form" } do |f| %>
        <input type="hidden" name="_method" id="agenda-event-form-method" value="post">
        <div class="mb-3">
          <%= f.date_field :event_date, id: "agenda-event-date", class: "form-control", required: true, value: Date.current.iso8601 %>
        </div>
        <div class="mb-3">
          <%= f.time_field :event_time, id: "agenda-event-time", class: "form-control", required: true, value: "09:00" %>
        </div>
        <div class="mb-3">
          <%= f.text_field :title, id: "agenda-event-title-input", class: "form-control", required: true, maxlength: 160, placeholder: "Event Title" %>
        </div>
        <div class="mb-3">
          <%= f.text_area :description, id: "agenda-event-description", class: "form-control", maxlength: 1000, placeholder: "Event Description..." %>
        </div>
        <div class="mb-3">
          <%= f.select :remind_minutes_before,
                       options_for_select([["Alarm yok", 0], ["5 dk once", 5], ["10 dk once", 10], ["15 dk once", 15], ["30 dk once", 30], ["1 saat once", 60]], 10),
                       { id: "agenda-event-remind" },
                       class: "form-select" %>
        </div>
        <div class="mb-3">
          <%= f.hidden_field :color, id: "agenda-event-color", value: "#38bdf8" %>
        </div>
        <div class="agenda-modal-footer">
          <button type="submit" class="agenda-modal-btn is-primary" id="agenda-event-submit-label">Add</button>
          <button type="button" class="agenda-modal-btn" id="agenda-close-modal">Close</button>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<script id="agenda-events-json" type="application/json"><%= raw(json_escape(calendar_events_json)) %></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
<script>
  let agendaCalendar = null

  const initAgendaCalendar = () => {
    const modal = document.getElementById("agenda-event-modal")
    const openBtn = document.getElementById("agenda-open-modal")
    const closeBtn = document.getElementById("agenda-close-modal")
    const form = document.getElementById("agenda-event-form")
    const formMethod = document.getElementById("agenda-event-form-method")
    const submitLabel = document.getElementById("agenda-event-submit-label")
    const inputDate = document.getElementById("agenda-event-date")
    const inputTime = document.getElementById("agenda-event-time")
    const inputTitle = document.getElementById("agenda-event-title-input")
    const inputDescription = document.getElementById("agenda-event-description")
    const inputColor = document.getElementById("agenda-event-color")
    const inputRemind = document.getElementById("agenda-event-remind")

    const resetModalForm = () => {
      if (!form) return
      form.action = "<%= calendar_events_path %>"
      if (formMethod) formMethod.value = "post"
      if (submitLabel) submitLabel.textContent = "Add"
      if (inputDate) inputDate.value = "<%= Date.current.iso8601 %>"
      if (inputTime) inputTime.value = "09:00"
      if (inputTitle) inputTitle.value = ""
      if (inputDescription) inputDescription.value = ""
      if (inputColor) inputColor.value = "#38bdf8"
      if (inputRemind) inputRemind.value = "10"
    }

    const openModalForCreate = () => {
      resetModalForm()
      if (!modal) return
      modal.classList.add("is-open")
      modal.setAttribute("aria-hidden", "false")
    }

    const openModalForEdit = (payload) => {
      if (!form || !payload || !payload.id) return

      form.action = "/calendar_events/" + payload.id
      if (formMethod) formMethod.value = "patch"
      if (submitLabel) submitLabel.textContent = "Update"
      if (inputDate) inputDate.value = payload.eventDate || "<%= Date.current.iso8601 %>"
      if (inputTime) inputTime.value = payload.eventTime || "09:00"
      if (inputTitle) inputTitle.value = payload.title || ""
      if (inputDescription) inputDescription.value = payload.description || ""
      if (inputColor) inputColor.value = payload.color || "#38bdf8"
      if (inputRemind) inputRemind.value = String(payload.remind || 0)

      if (!modal) return
      modal.classList.add("is-open")
      modal.setAttribute("aria-hidden", "false")
    }

    if (modal && openBtn && closeBtn && modal.dataset.bindReady !== "1") {
      const closeModal = () => {
        modal.classList.remove("is-open")
        modal.setAttribute("aria-hidden", "true")
      }

      modal.dataset.bindReady = "1"
      openBtn.addEventListener("click", openModalForCreate)
      closeBtn.addEventListener("click", closeModal)
      modal.addEventListener("click", (event) => {
        if (event.target === modal) closeModal()
      })
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeModal()
      })
    }

    if (modal && !modal.dataset.editBindReady) {
      document.querySelectorAll("[data-agenda-edit-event='1']").forEach((btn) => {
        btn.addEventListener("click", () => {
          openModalForEdit({
            id: btn.dataset.eventId,
            eventDate: btn.dataset.eventDate,
            eventTime: btn.dataset.eventTime,
            title: btn.dataset.eventTitle,
            description: btn.dataset.eventDescription,
            color: btn.dataset.eventColor,
            remind: btn.dataset.eventRemind
          })
        })
      })
      modal.dataset.editBindReady = "1"
    }

    const calendarEl = document.getElementById("agenda-calendar")
    if (!calendarEl || !window.FullCalendar) return

    if (agendaCalendar) {
      agendaCalendar.destroy()
      agendaCalendar = null
    }

    const eventsEl = document.getElementById("agenda-events-json")
    const events = eventsEl ? JSON.parse(eventsEl.textContent || "[]") : []

    agendaCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      aspectRatio: 2.35,
      height: "auto",
      contentHeight: "auto",
      expandRows: true,
      displayEventTime: true,
      eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek"
      },
      buttonText: {
        today: "today",
        month: "month",
        week: "week",
        day: "day",
        list: "list"
      },
      firstDay: 1,
      fixedWeekCount: true,
      dayMaxEvents: 2,
      events: events,
      eventClick: (info) => {
        const start = info.event.start
        if (!start) return

        const yyyy = start.getFullYear()
        const mm = String(start.getMonth() + 1).padStart(2, "0")
        const dd = String(start.getDate()).padStart(2, "0")
        const hh = String(start.getHours()).padStart(2, "0")
        const mi = String(start.getMinutes()).padStart(2, "0")

        openModalForEdit({
          id: info.event.id,
          eventDate: `${yyyy}-${mm}-${dd}`,
          eventTime: `${hh}:${mi}`,
          title: info.event.title,
          description: info.event.extendedProps.description || "",
          color: info.event.backgroundColor || "#38bdf8",
          remind: info.event.extendedProps.remindMinutesBefore || 0
        })
      }
    })

    agendaCalendar.render()
    setTimeout(() => agendaCalendar && agendaCalendar.updateSize(), 0)
  }

  document.addEventListener("turbo:load", initAgendaCalendar)
  document.addEventListener("turbo:render", initAgendaCalendar)
  document.addEventListener("turbo:before-cache", () => {
    if (agendaCalendar) {
      agendaCalendar.destroy()
      agendaCalendar = null
    }
  })
</script>
