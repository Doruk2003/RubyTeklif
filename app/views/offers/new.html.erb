<div class="row g-3">
  <div class="col-12">
    <div class="card shadow-sm app-header-card">
      <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-3">
        <div>
          <h1 class="h4 mb-1 text-white">Yeni Teklif</h1>
          <p class="text-secondary mb-0">Müşteri ve kategoriye göre ürün seçerek teklif oluşturun.</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 app-header-actions">
          <%= list_nav_button(offers_path, label: "Listeye Dön", class_name: "app-header-icon-btn") %>
          <%= home_nav_button(home_path, class_name: "app-header-icon-btn", icon: "home") %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <%= filter_form_with url: new_offer_path, layout: :two, class_name: app_form_class do |f| %>
          <div class="form-floating">
            <%= f.select :category_id,
                  options_for_select([["Tüm Kategoriler", ""]] + @category_options, @selected_category_id),
                  {},
                  class: "form-select",
                  data: { float_empty: true } %>
            <%= f.label :category_id, "Kategori" %>
          </div>
          <%= filter_actions_row do %>
            <%= filter_submit_button(label: "Ürünleri Filtrele") %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <%= form_with url: offers_path, method: :post, scope: :offer, local: true, class: app_form_class("row g-3") do |f| %>
          <div class="col-12 col-md-6">
            <div class="form-floating">
              <%= f.select :company_id,
                    options_for_select(@companies.map { |c| [c["name"], c["id"]] }, @offer["company_id"]),
                    { prompt: "Müşteri seçin" },
                    class: "form-select",
                    data: { float_empty: true } %>
              <%= f.label :company_id, "Müşteri" %>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating">
              <%= f.text_field :offer_number, value: @offer["offer_number"], placeholder: "Teklif No", class: "form-control" %>
              <%= f.label :offer_number, "Teklif No" %>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating">
              <%= f.date_field :offer_date, value: @offer["offer_date"], class: "form-control", placeholder: "Tarih" %>
              <%= f.label :offer_date, "Tarih" %>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="form-floating">
              <%= f.select :status,
                    options_for_select(Offers::Status::ALLOWED.map { |s| [s.humanize, s] }, @offer["status"] || "taslak"),
                    {},
                    class: "form-select",
                    data: { float_empty: true } %>
              <%= f.label :status, "Durum" %>
            </div>
          </div>

          <div class="col-12">
            <div class="border rounded p-3 bg-light bg-opacity-50"
                 data-controller="offer-items"
                 data-offer-items-prices-value="<%= json_escape(@products.each_with_object({}) { |p, acc| acc[p['id'].to_s] = p['price'].to_s }.to_json) %>">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
                <div class="small fw-bold text-uppercase text-secondary" style="letter-spacing: 0.05em; font-size: 0.75rem;">Teklif Kalemleri</div>
                <button type="button" class="btn btn-sm btn-dark px-3" data-action="offer-items#add">
                  <span class="d-flex align-items-center gap-1">
                    <span class="material-symbols-outlined fs-6">add_circle</span>
                    Kalem Ekle
                  </span>
                </button>
              </div>
              <%= f.hidden_field :product_category_id, value: @selected_category_id %>

              <% item_rows = Array(@items) %>
              <% item_rows = [{}] if item_rows.empty? %>

              <div class="d-grid gap-3" data-offer-items-target="list">
                <% item_rows.each do |item| %>
                  <div class="bg-white border rounded p-4 shadow-sm position-relative" data-offer-items-row>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 position-absolute top-0 end-0 m-2" data-action="offer-items#remove" title="Sil">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                    
                    <div class="row g-3 mt-1">
                      <div class="col-12 col-md-5">
                        <div class="form-floating">
                          <%= select_tag "offer[items][][product_id]",
                                options_for_select(@products.map { |p| ["#{p["name"]} (#{p.dig("categories", "name").to_s.presence || @category_labels[p["category_id"].to_s].presence || "-"})", p["id"]] }, item[:product_id] || item["product_id"]),
                                prompt: "Ürün seçin",
                                data: { action: "change->offer-items#productChanged", float_empty: true },
                                class: "form-select" %>
                          <label>Ürün</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-2">
                        <div class="form-floating">
                          <%= number_field_tag "offer[items][][quantity]", item[:quantity] || item["quantity"] || "1", step: "0.01", class: "form-control", placeholder: "Miktar" %>
                          <label>Miktar</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-3">
                        <div class="form-floating">
                          <%= number_field_tag "offer[items][][unit_price]", item[:unit_price] || item["unit_price"], step: "0.01", class: "form-control", placeholder: "Birim Fiyat" %>
                          <label>Birim Fiyat</label>
                        </div>
                      </div>

                      <div class="col-12 col-md-2">
                        <div class="form-floating">
                          <%= number_field_tag "offer[items][][discount_rate]", item[:discount_rate] || item["discount_rate"] || "0", step: "0.01", min: "0", max: "100", class: "form-control", placeholder: "İskonto" %>
                          <label>İskonto %</label>
                        </div>
                      </div>
                    </div>

                    <div class="mt-3">
                      <div class="form-floating">
                        <%= text_field_tag "offer[items][][description]", item[:description] || item["description"], class: "form-control", placeholder: "Açıklama" %>
                        <label>Açıklama (Opsiyonel)</label>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>

              <template data-offer-items-target="template">
                <div class="bg-white border rounded p-4 shadow-sm position-relative" data-offer-items-row>
                  <button type="button" class="btn btn-sm btn-outline-danger border-0 position-absolute top-0 end-0 m-2" data-action="offer-items#remove" title="Sil">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                  
                  <div class="row g-3 mt-1">
                    <div class="col-12 col-md-5">
                      <div class="form-floating">
                        <%= select_tag "offer[items][][product_id]",
                              options_for_select(@products.map { |p| ["#{p["name"]} (#{p.dig("categories", "name").to_s.presence || @category_labels[p["category_id"].to_s].presence || "-"})", p["id"]] }),
                              prompt: "Ürün seçin",
                              data: { action: "change->offer-items#productChanged", float_empty: true },
                              class: "form-select" %>
                        <label>Ürün</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-2">
                      <div class="form-floating">
                        <%= number_field_tag "offer[items][][quantity]", "1", step: "0.01", class: "form-control", placeholder: "Miktar" %>
                        <label>Miktar</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-3">
                      <div class="form-floating">
                        <%= number_field_tag "offer[items][][unit_price]", nil, step: "0.01", class: "form-control", placeholder: "Birim Fiyat" %>
                        <label>Birim Fiyat</label>
                      </div>
                    </div>

                    <div class="col-12 col-md-2">
                      <div class="form-floating">
                        <%= number_field_tag "offer[items][][discount_rate]", "0", step: "0.01", min: "0", max: "100", class: "form-control", placeholder: "İskonto" %>
                        <label>İskonto %</label>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <div class="form-floating">
                      <%= text_field_tag "offer[items][][description]", nil, class: "form-control", placeholder: "Açıklama" %>
                      <label>Açıklama (Opsiyonel)</label>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <div class="col-12 mt-4 pt-3 border-top">
            <%= f.submit "Teklifi Kaydet", class: "btn btn-primary w-100 py-3 fw-bold text-uppercase", style: "letter-spacing: 0.1em;", data: { turbo_confirm: "Teklif kaydedilsin mi?" } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
