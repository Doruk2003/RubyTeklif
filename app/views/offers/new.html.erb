<div class="container-fluid py-2">
  <div class="row g-2">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-3">
          <div>
            <h1 class="h4 mb-1">Yeni Teklif</h1>
            <p class="text-secondary mb-0">Müşteri ve kategoriye göre ürün seçerek teklif oluşturun.</p>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <%= link_to "Listeye Dön", offers_path, class: "btn-secondary w-100" %>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <%= filter_form_with url: new_offer_path, layout: :two do |f| %>
            <div>
              <%= f.label :category_id, "Kategori", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
              <%= f.select :category_id,
                    options_for_select([["Tüm Kategoriler", ""]] + @category_options, @selected_category_id),
                    {},
                    class: "form-input" %>
            </div>
            <%= filter_actions_row do %>
              <%= filter_submit_button(label: "Ürünleri Filtrele") %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <%= form_with url: offers_path, method: :post, scope: :offer, local: true, class: "row g-2" do |f| %>
            <div class="col-12 col-md-6">
              <%= f.label :company_id, "Müşteri", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
              <%= f.select :company_id,
                    options_for_select(@companies.map { |c| [c["name"], c["id"]] }, @offer["company_id"]),
                    { prompt: "Müşteri seçin" },
                    class: "form-input" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :offer_number, "Teklif No", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
              <%= f.text_field :offer_number, value: @offer["offer_number"], placeholder: "Orn: TK-2026-001", class: "form-input" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :offer_date, "Tarih", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
              <%= f.date_field :offer_date, value: @offer["offer_date"], class: "form-input" %>
            </div>

            <div class="col-12 col-md-6">
              <%= f.label :status, "Durum", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
              <%= f.select :status,
                    options_for_select(Offers::Status::ALLOWED.map { |s| [s.humanize, s] }, @offer["status"] || "taslak"),
                    {},
                    class: "form-input" %>
            </div>

            <div class="col-12 border rounded p-3"
                 data-controller="offer-items"
                 data-offer-items-prices-value="<%= json_escape(@products.each_with_object({}) { |p, acc| acc[p['id'].to_s] = p['price'].to_s }.to_json) %>">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-3">
                <div class="small fw-semibold text-uppercase text-secondary">Teklif Kalemleri</div>
                <button type="button" class="btn-secondary" data-action="offer-items#add">Kalem Ekle</button>
              </div>
              <%= f.hidden_field :product_category_id, value: @selected_category_id %>

              <% item_rows = Array(@items) %>
              <% item_rows = [{}] if item_rows.empty? %>

              <div class="d-grid gap-3" data-offer-items-target="list">
                <% item_rows.each do |item| %>
                  <div class="border rounded p-3" data-offer-items-row>
                    <div class="text-end mb-2">
                      <button type="button" class="btn btn-link btn-sm text-danger p-0" data-action="offer-items#remove">Sil</button>
                    </div>
                    <div class="row g-2">
                      <div class="col-12 col-md-5">
                        <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Ürün</label>
                        <%= select_tag "offer[items][][product_id]",
                              options_for_select(@products.map { |p| ["#{p["name"]} (#{p.dig("categories", "name").to_s.presence || @category_labels[p["category_id"].to_s].presence || "-"})", p["id"]] }, item[:product_id] || item["product_id"]),
                              prompt: "Ürün seçin",
                              data: { action: "change->offer-items#productChanged" },
                              class: "form-input" %>
                      </div>

                      <div class="col-12 col-md-2">
                        <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Miktar</label>
                        <%= number_field_tag "offer[items][][quantity]", item[:quantity] || item["quantity"] || "1", step: "0.01", class: "form-input" %>
                      </div>

                      <div class="col-12 col-md-3">
                        <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Birim Fiyat</label>
                        <%= number_field_tag "offer[items][][unit_price]", item[:unit_price] || item["unit_price"], step: "0.01", class: "form-input" %>
                      </div>

                      <div class="col-12 col-md-2">
                        <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">İskonto %</label>
                        <%= number_field_tag "offer[items][][discount_rate]", item[:discount_rate] || item["discount_rate"] || "0", step: "0.01", min: "0", max: "100", class: "form-input" %>
                      </div>
                    </div>

                    <div class="mt-3">
                      <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Açıklama</label>
                      <%= text_field_tag "offer[items][][description]", item[:description] || item["description"], class: "form-input", placeholder: "Boş bırakırsanız ürün adı kullanılır" %>
                    </div>
                  </div>
                <% end %>
              </div>

              <template data-offer-items-target="template">
                <div class="border rounded p-3" data-offer-items-row>
                  <div class="text-end mb-2">
                    <button type="button" class="btn btn-link btn-sm text-danger p-0" data-action="offer-items#remove">Sil</button>
                  </div>
                  <div class="row g-2">
                    <div class="col-12 col-md-5">
                      <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Ürün</label>
                      <%= select_tag "offer[items][][product_id]",
                            options_for_select(@products.map { |p| ["#{p["name"]} (#{p.dig("categories", "name").to_s.presence || @category_labels[p["category_id"].to_s].presence || "-"})", p["id"]] }),
                            prompt: "Ürün seçin",
                            data: { action: "change->offer-items#productChanged" },
                            class: "form-input" %>
                    </div>

                    <div class="col-12 col-md-2">
                      <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Miktar</label>
                      <%= number_field_tag "offer[items][][quantity]", "1", step: "0.01", class: "form-input" %>
                    </div>

                    <div class="col-12 col-md-3">
                      <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Birim Fiyat</label>
                      <%= number_field_tag "offer[items][][unit_price]", nil, step: "0.01", class: "form-input" %>
                    </div>

                    <div class="col-12 col-md-2">
                      <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">İskonto %</label>
                      <%= number_field_tag "offer[items][][discount_rate]", "0", step: "0.01", min: "0", max: "100", class: "form-input" %>
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label text-uppercase small fw-semibold text-secondary mb-1">Açıklama</label>
                    <%= text_field_tag "offer[items][][description]", nil, class: "form-input", placeholder: "Boş bırakırsanız ürün adı kullanılır" %>
                  </div>
                </div>
              </template>
            </div>

            <div class="col-12">
              <%= f.submit "Teklifi Kaydet", class: "btn-primary w-100", data: { turbo_confirm: "Teklif kaydedilsin mi?" } %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>


