<% value_for = ->(key, default = nil) { product[key].nil? ? (product[key.to_s].nil? ? default : product[key.to_s]) : product[key] } %>
<% stock_value = value_for.call(:is_stock_item, true) %>
<% sale_vat_included = value_for.call(:sale_price_vat_included, false) %>
<% cost_vat_included = value_for.call(:cost_price_vat_included, false) %>
<% active_value = value_for.call(:active, true) %>
<%= form_with url: url, method: method, scope: :product, local: true, class: app_form_class("rt-product-form") do |f| %>

<% is_editing = value_for.call(:id).present? %>

<div class="card mb-2 bg-white border border-1 border-light p-4 rounded shadow-sm">

  <div class="row g-3">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :sku, value: value_for.call(:sku), placeholder: "Stok Kodu", class: "form-control", autocomplete: "off" %>
        <%= f.label :sku, "Stok Kodu" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :name, value: value_for.call(:name), placeholder: "Ürün Adı", class: "form-control" %>
        <%= f.label :name, "Ürün Adı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :barcode, value: value_for.call(:barcode), placeholder: "Barkod", class: "form-control", autocomplete: "off" %>
        <%= f.label :barcode, "Barkod / GTIN" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :gtip_code, value: value_for.call(:gtip_code), placeholder: "GTIP Kodu", class: "form-control", maxlength: 50, autocomplete: "off" %>
        <%= f.label :gtip_code, "GTIP Kodu" %>
      </div>
    </div>

    <div class="col-12">
      <div class="form-floating">
        <%= f.text_area :description, value: value_for.call(:description), placeholder: "Açıklama", class: "form-control", style: "height: 72px;" %>
        <%= f.label :description, "Açıklama" %>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3 bg-white border border-1 border-light p-4 rounded shadow-sm">
  <div class="row g-3">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :category_id,
              options_for_select(@category_options, value_for.call(:category_id)),
              { prompt: "Kategori Seçin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :category_id, "Kategori" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :brand_id,
              options_for_select(@brand_options, value_for.call(:brand_id)),
              { prompt: "Marka Seçmeden Devam Edebilirsiniz" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :brand_id, "Marka" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :item_type,
              options_for_select(Products::UpsertForm::ITEM_TYPE_OPTIONS, value_for.call(:item_type)),
              { prompt: "Tip Seçin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :item_type, "Tip" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :unit,
              options_for_select(Products::UpsertForm::UNIT_OPTIONS, value_for.call(:unit, "Adet")),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :unit, "Birim" %>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3 bg-white border border-1 border-light p-4 rounded shadow-sm">
  <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-cash-stack me-2"></i>Fiyatlandırma</h6>
  <div class="row g-3 align-items-end">
    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.select :currency_id,
              options_for_select(@currency_options, value_for.call(:currency_id)),
              { prompt: "Döviz Seçin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :currency_id, "Döviz" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.number_field :price, value: value_for.call(:price), step: "0.01", placeholder: "Satış Fiyatı", class: "form-control" %>
        <%= f.label :price, "Satış Fiyatı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.select :sale_price_vat_included,
              options_for_select([["KDV Hariç", "0"], ["KDV Dahil", "1"]], sale_vat_included.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :sale_price_vat_included, "Satış KDV" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.number_field :cost_price, value: value_for.call(:cost_price, 0), step: "0.01", placeholder: "Maliyet Fiyatı", class: "form-control" %>
        <%= f.label :cost_price, "Maliyet Fiyatı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.select :cost_price_vat_included,
              options_for_select([["KDV Hariç", "0"], ["KDV Dahil", "1"]], cost_vat_included.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :cost_price_vat_included, "Maliyet KDV" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-2">
      <div class="form-floating">
        <%= f.select :vat_rate,
              options_for_select([["0%", "0"], ["1%", "1"], ["8%", "8"], ["10%", "10"], ["18%", "18"], ["20%", "20"]], value_for.call(:vat_rate, 0).to_f.round.to_s),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :vat_rate, "KDV Oranı" %>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-6">
    <div class="card h-100 bg-white border border-1 border-light p-4 rounded shadow-sm">
      <h6 class="fw-bold text-secondary mb-3"><i class="bi bi-box-seam me-2"></i>Stok ve Durum</h6>
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-6 col-lg-3">
          <div class="form-floating">
            <%= f.select :is_stock_item,
                  options_for_select([["Evet", "1"], ["Hayır", "0"]], value_for.call(:is_stock_item, true).to_s.downcase.in?(%w[true 1 t]) ? "1" : "0"),
                  {},
                  class: "form-select",
                  data: { float_empty: true } %>
            <%= f.label :is_stock_item, "Stok Takibi" %>
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
          <div class="form-floating">
            <%= f.number_field :stock_quantity, value: value_for.call(:stock_quantity, 0).to_f.to_i, step: "1", placeholder: "Mevcut Stok", class: "form-control" %>
            <%= f.label :stock_quantity, "Mevcut Stok" %>
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
          <div class="form-floating">
            <%= f.number_field :min_stock_level, value: value_for.call(:min_stock_level, 0).to_f.to_i, step: "1", placeholder: "Minimum Stok", class: "form-control" %>
            <%= f.label :min_stock_level, "Minimum Stok" %>
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
          <div class="form-floating">
            <%= f.select :active,
                  options_for_select([["Aktif", "1"], ["Pasif", "0"]], value_for.call(:active, true).to_s.downcase.in?(%w[true 1 t]) ? "1" : "0"),
                  {},
                  class: "form-select",
                  data: { float_empty: true } %>
            <%= f.label :active, "Durum" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card h-100 bg-white border border-1 border-light p-4 rounded shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-bold text-secondary mb-0">Ürün Fotoğrafları</h6>
        <span class="badge bg-light text-secondary border fw-normal" id="photo_count_badge">0 / 6</span>
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 overflow-visible">
        <div class="text-start">
          <%= f.file_field :photos, multiple: true, accept: "image/png, image/jpeg, image/jpg, image/webp", class: "d-none", id: "photo_upload" %>
          <label for="photo_upload" class="btn btn-warning btn-sm d-inline-flex align-items-center gap-2 mb-2">
            <span class="material-symbols-outlined" style="font-size: 18px;">add_a_photo</span>
            <span>Fotoğraf Seç</span>
          </label>
          <p class="small text-muted mb-0"><%= local_assigns[:existing_photo_count] ? (6 - local_assigns[:existing_photo_count]) : 6 %> Adet PNG, JPG, WEBP yüklenebilir.</p>
        </div>

        <div class="flex-grow-1 d-flex gap-2 flex-nowrap justify-content-end overflow-visible" style="min-width: 0;">
          <%# Mevcut Fotoğraflar (Düzenleme Modu için) %>
          <% if local_assigns[:existing_photos].present? %>
            <% local_assigns[:existing_photos].each_with_index do |image, index| %>
              <% image_url = product_image_public_url(image["storage_path"]) %>
              <div class="preview-image-wrapper existing-photo" style="flex-shrink: 0;">
                <img src="<%= image_url %>" alt="Ürün fotoğrafı" />
                <div class="existing-photo-actions d-none position-absolute top-0 start-0 w-100 h-100 rounded" style="z-index: 101; background: rgba(0,0,0,0.1);">
                  <button type="button" 
                          data-delete-url="<%= destroy_image_product_path(@product["id"], image_id: image["id"]) %>"
                          data-confirm="Silinsin mi?"
                          class="btn btn-danger p-0 d-flex align-items-center justify-content-center rounded-circle position-absolute rt-delete-confirm-btn" 
                          style="width: 14px; height: 14px; top: 2px; right: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                    <span class="material-symbols-outlined" style="font-size: 10px;">delete</span>
                  </button>
                </div>
              </div>
            <% end %>
          <% end %>

          <%# Yeni Seçilen Fotoğraflar (Önizleme) %>
          <div id="image_previews_container" class="d-flex gap-2 flex-nowrap d-none overflow-visible">
            <!-- Previews will go here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .preview-image-wrapper {
    width: 3.5rem;
    height: 3.5rem;
    position: relative;
    border-radius: 0.375rem;
    overflow: visible;
    border: 1px solid #dee2e6;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    background: #f8fafc;
    transition: transform 0.2s ease-in-out, z-index 0.2s step-end;
    z-index: 1;
  }
  .preview-image-wrapper:hover {
    z-index: 2;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    cursor: zoom-in;
  }
  .preview-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0.375rem;
    display: block;
    background: white;
  }
  .preview-image-wrapper.existing-photo:hover .existing-photo-actions {
    display: flex !important;
  }
  .btn-xs {
    width: 20px;
    height: 20px;
    min-width: 20px;
  }
  .btn-remove-photo {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 14px;
    height: 14px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
</style>

<div class="d-grid mt-4">
  <%= f.submit(submit_label.presence || "Kaydet", class: "btn btn-success py-3 fw-bold shadow-sm", data: { turbo_confirm: submit_confirm.presence || "Kaydedilsin mi?" }) %>
</div>
<% end %>

<!-- Photo Lightbox Modal -->
<div id="rt_photo_lightbox" class="fixed-top w-100 h-100 d-none align-items-center justify-content-center bg-dark bg-opacity-75" style="z-index: 9999; cursor: zoom-out;" onclick="closeRtLightbox()">
  <div class="position-relative p-3" style="max-width: 90vw; max-height: 90vh;">
    <button type="button" class="btn btn-dark btn-sm rounded-circle position-absolute top-0 end-0 m-2 border border-secondary" style="z-index: 10001;" onclick="event.stopPropagation(); closeRtLightbox();">
      <span class="material-symbols-outlined fs-5">close</span>
    </button>
    <img id="rt_lightbox_img" src="" class="img-fluid rounded shadow-lg border border-secondary border-opacity-25" style="max-height: 85vh; object-fit: contain;">
  </div>
</div>

<script>
  // Global Lightbox Functions
  window.rtShowLightbox = function(src) {
    const lightbox = document.getElementById('rt_photo_lightbox');
    const lightboxImg = document.getElementById('rt_lightbox_img');
    if (lightbox && lightboxImg) {
      lightboxImg.src = src;
      lightbox.classList.remove('d-none');
      lightbox.classList.add('d-flex');
      document.body.style.overflow = 'hidden'; // Scroll stop
    }
  };

  window.closeRtLightbox = function() {
    const lightbox = document.getElementById('rt_photo_lightbox');
    if (lightbox) {
      lightbox.classList.add('d-none');
      lightbox.classList.remove('d-flex');
      document.body.style.overflow = ''; // Scroll resume
    }
  };

  (function() {
    let selectedFiles = [];

    function setupPhotoUpload() {
      const photoUpload = document.getElementById('photo_upload');
      const container = document.getElementById('image_previews_container');
      const badge = document.getElementById('photo_count_badge');
      
      if (!photoUpload || !container) return;
      if (photoUpload.dataset.photoInit === 'true') return;
      photoUpload.dataset.photoInit = 'true';

      selectedFiles = [];
      updateDisplay();

      photoUpload.addEventListener('change', (e) => {
        const newFiles = Array.from(e.target.files);
        newFiles.forEach(file => {
          const isDuplicate = selectedFiles.some(f => f.name === file.name && f.size === file.size);
          if (!isDuplicate && (selectedFiles.length + (<%= local_assigns[:existing_photo_count] || 0 %>)) < 6) {
            selectedFiles.push(file);
          }
        });
        e.target.value = '';
        updateDisplay();
      });

      function updateDisplay() {
        container.innerHTML = '';
        if (selectedFiles.length > 0) container.classList.remove('d-none');
        else container.classList.add('d-none');

        selectedFiles.forEach((file, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'preview-image-wrapper';
          
          const img = document.createElement('img');
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn-remove-photo';
          removeBtn.innerHTML = '×';
          removeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); removeFile(index); };

          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          container.appendChild(wrapper);

          const reader = new FileReader();
          reader.onload = (evt) => { img.src = evt.target.result; };
          reader.readAsDataURL(file);
        });

        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        photoUpload.files = dt.files;

        if (badge) {
          const total = selectedFiles.length + (<%= local_assigns[:existing_photo_count] || 0 %>);
          badge.textContent = `${total} / 6`;
          badge.className = total >= 6 ? 'badge bg-danger text-white border' : 'badge bg-light text-secondary border fw-normal';
        }
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateDisplay();
      }
    }

    // Event Delegation for Lightbox & Delete
    document.addEventListener('click', (e) => {
      // Lightbox Trigger
      const wrapper = e.target.closest('.preview-image-wrapper');
      const isDeleteBtn = e.target.closest('.rt-delete-confirm-btn') || e.target.closest('.btn-remove-photo');
      
      if (wrapper && !isDeleteBtn) {
        const img = wrapper.querySelector('img');
        if (img && img.src) window.rtShowLightbox(img.src);
      }

      // Existing Photo Delete (Manual submit to avoid link_to issues inside forms)
      const delBtn = e.target.closest('.rt-delete-confirm-btn');
      if (delBtn) {
        e.preventDefault();
        e.stopPropagation();
        if (confirm(delBtn.dataset.confirm)) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = delBtn.dataset.deleteUrl;
          const m = document.createElement('input'); m.type = 'hidden'; m.name = '_method'; m.value = 'DELETE';
          const t = document.createElement('input'); t.type = 'hidden'; t.name = 'authenticity_token'; t.value = document.querySelector('meta[name="csrf-token"]')?.content;
          form.appendChild(m); form.appendChild(t);
          document.body.appendChild(form); form.submit();
        }
      }
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupPhotoUpload);
    } else {
      setupPhotoUpload();
    }
    document.addEventListener('turbo:load', setupPhotoUpload);
  })();
</script>
