<% value_for = ->(key, default = nil) { product[key].nil? ? (product[key.to_s].nil? ? default : product[key.to_s]) : product[key] } %>
<% stock_value = value_for.call(:is_stock_item, true) %>
<% sale_vat_included = value_for.call(:sale_price_vat_included, false) %>
<% cost_vat_included = value_for.call(:cost_price_vat_included, false) %>
<% active_value = value_for.call(:active, true) %>
<%= form_with url: url, method: method, scope: :product, local: true, class: app_form_class("rt-product-form") do |f| %>

<div class="card mb-2 bg-white border border-1 border-light p-4 rounded">
  <div class="row g-3 align-items-end">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :sku, value: value_for.call(:sku), placeholder: "Stok Kodu", class: "form-control", autocomplete: "off" %>
        <%= f.label :sku, "Stok Kodu" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :name, value: value_for.call(:name), placeholder: "Urun Adi", class: "form-control" %>
        <%= f.label :name, "Urun Adı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.text_field :barcode, value: value_for.call(:barcode), placeholder: "Barkod", class: "form-control", autocomplete: "off" %>
        <%= f.label :barcode, "Barkod / GTIN" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :is_stock_item,
              options_for_select([["Evet", "1"], ["Hayir", "0"]], stock_value.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :is_stock_item, "Stok Ürünü" %>
      </div>
    </div>

    <div class="col-12">
      <div class="form-floating">
        <%= f.text_area :description, value: value_for.call(:description), placeholder: "Aciklama", class: "form-control", style: "height: 72px;" %>
        <%= f.label :description, "Açıklama" %>
      </div>
    </div>
  </div>
</div>

<div class="card mb-2 bg-white border border-1 border-light p-4 rounded">
  <div class="row g-3 align-items-end">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :category_id,
              options_for_select(@category_options, value_for.call(:category_id)),
              { prompt: "Kategori seçin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :category_id, "Kategori" %>
      </div>
      <div class="mt-1">
        <%= link_to "Yeni Kategori", new_category_path(return_to: request.fullpath), class: "small link-secondary text-decoration-none" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :item_type,
              options_for_select(Products::UpsertForm::ITEM_TYPE_OPTIONS, value_for.call(:item_type)),
              { prompt: "Tip seçin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :item_type, "Tip" %>
      </div>
      <div class="mt-1 small invisible">placeholder</div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :brand_id,
              options_for_select(@brand_options, value_for.call(:brand_id)),
              { prompt: "Marka seçmeden devam edebilirsin" },
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :brand_id, "Marka" %>
      </div>
      <div class="mt-1">
        <%= link_to "Yeni Marka", new_brand_path(return_to: request.fullpath), class: "small link-secondary text-decoration-none" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :unit,
              options_for_select(Products::UpsertForm::UNIT_OPTIONS, value_for.call(:unit, "adet")),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :unit, "Birim" %>
      </div>
      <div class="mt-1 small invisible">placeholder</div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.number_field :price, value: value_for.call(:price), step: "0.01", placeholder: "Satış Fiyatı", class: "form-control" %>
        <%= f.label :price, "Satış Fiyatı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :sale_price_vat_included,
              options_for_select([["KDV Hariç", "0"], ["KDV Dahil", "1"]], sale_vat_included.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :sale_price_vat_included, "Satış KDV Durumu" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.number_field :cost_price, value: value_for.call(:cost_price, 0), step: "0.01", placeholder: "Maliyet Fiyatı", class: "form-control" %>
        <%= f.label :cost_price, "Maliyet Fiyatı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :cost_price_vat_included,
              options_for_select([["KDV Hariç", "0"], ["KDV Dahil", "1"]], cost_vat_included.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :cost_price_vat_included, "Maliyet KDV Durumu" %>
      </div>
    </div>
  </div>
</div>

<div class="card mb-2 bg-white border border-1 border-light p-4 rounded">
  <div class="row g-3 align-items-end">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :vat_rate,
              options_for_select([["0%", "0"], ["8%", "8"], ["10%", "10"], ["18%", "18"], ["20%", "20"]], value_for.call(:vat_rate, "0")),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :vat_rate, "KDV Oranı" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.number_field :stock_quantity, value: value_for.call(:stock_quantity, 0), step: "0.01", placeholder: "Mevcut Stok", class: "form-control" %>
        <%= f.label :stock_quantity, "Mevcut Stok" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.number_field :min_stock_level, value: value_for.call(:min_stock_level, 0), step: "0.01", placeholder: "Minimum Stok", class: "form-control" %>
        <%= f.label :min_stock_level, "Minimum Stok" %>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-3">
      <div class="form-floating">
        <%= f.select :active,
              options_for_select([["Aktif", "1"], ["Pasif", "0"]], active_value.to_s.in?(%w[true 1]) ? "1" : "0"),
              {},
              class: "form-select",
              data: { float_empty: true } %>
        <%= f.label :active, "Durum" %>
      </div>
    </div>
  </div>
</div>

<style>
  .preview-image-wrapper {
    width: 3.5rem;
    height: 3.5rem;
    position: relative;
    transition: transform 0.2s ease-in-out, z-index 0.2s step-end;
    border-radius: 0.375rem;
    overflow: hidden;
    cursor: zoom-in;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    z-index: 1;
    border: 1px solid #dee2e6;
  }
  .preview-image-wrapper:hover {
    transform: scale(3);
    z-index: 10;
    transition: transform 0.2s ease-in-out, z-index 0s step-start;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
  }
  .preview-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>
<div class="card mb-2 bg-white border border-1 border-light p-4 rounded">
  <h6 class="fw-semibold text-secondary mb-2">Fotograf</h6>

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <%= f.file_field :photos, multiple: true, accept: "image/png, image/jpeg, image/jpg, image/webp", class: "d-none", id: "photo_upload" %>
        <label for="photo_upload" class="btn btn-warning btn-sm mb-0">Dosyalari Sec</label>
        <span class="text-muted small" id="photo_file_names">Dosya secilmemis</span>
      </div>
      <p class="small text-muted mb-0 mt-2">Maksimum 6 adet fotograf (PNG, JPG, WEBP) yukleyebilirsiniz.</p>
    </div>

    <div id="image_previews_container" class="d-flex gap-2 flex-wrap justify-content-end d-none"></div>
  </div>
</div>

<div class="d-grid mt-2">
  <%= f.submit(submit_label.presence || "Kaydet", class: "btn btn-success py-2", data: { turbo_confirm: submit_confirm.presence || "Kaydedilsin mi?" }) %>
</div>
<% end %>

<script>
  document.addEventListener('turbo:load', setupPhotoUpload);
  document.addEventListener('DOMContentLoaded', setupPhotoUpload);

  function setupPhotoUpload() {
    const photoUpload = document.getElementById('photo_upload');
    const photoFileNames = document.getElementById('photo_file_names');
    const imagePreviewsContainer = document.getElementById('image_previews_container');

    if (photoUpload && photoFileNames && imagePreviewsContainer) {
      photoUpload.addEventListener('change', (e) => {
        const files = e.target.files;
        imagePreviewsContainer.innerHTML = '';

        if (files.length > 6) {
          alert('En fazla 6 adet fotograf yukleyebilirsiniz.');
          photoUpload.value = '';
          photoFileNames.textContent = 'Dosya secilmemis';
          imagePreviewsContainer.classList.add('d-none');
          return;
        }

        if (files.length === 0) {
          photoFileNames.textContent = 'Dosya secilmemis';
          imagePreviewsContainer.classList.add('d-none');
        } else {
          if (files.length === 1) {
            photoFileNames.textContent = files[0].name;
          } else {
            photoFileNames.textContent = files.length + ' dosya secildi';
          }

          imagePreviewsContainer.classList.remove('d-none');

          Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
              const wrapper = document.createElement('div');
              wrapper.className = 'preview-image-wrapper bg-light';

              const img = document.createElement('img');
              img.src = evt.target.result;

              wrapper.appendChild(img);
              imagePreviewsContainer.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
          });
        }
      });
    }
  }
</script>
