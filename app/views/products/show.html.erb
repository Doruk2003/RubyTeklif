<% if @product.present? %>
    <% 
      currency_name = (@product.dig("currencies", "name") || @currency_labels[@product["currency_id"].to_s]).to_s.presence || "Döviz Bilgisi Yok"
      currency_symbol = (@product.dig("currencies", "symbol") || @currency_symbols[@product["currency_id"].to_s] || "TL ").to_s
      price_unit = "#{currency_symbol} "
    %>

    <div class="row g-3">
      <!-- HEADER CARD -->
      <div class="col-12 mb-2">
        <div class="card shadow-sm app-header-card border-0 rounded-1 overflow-hidden">
          <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 p-4">
            <div class="d-flex align-items-center gap-3">
              <div>
                <h1 class="h4 fw-bold mb-0 text-white"><%= @product["name"] %></h1>
                <div class="d-flex align-items-center gap-2 mt-1">
                  <span class="badge bg-white bg-opacity-10 text-white-50 border border-white border-opacity-10 fw-normal small"><%= @product["sku"].presence || "No SKU" %></span>
                  <span class="text-white-50 small">|</span>
                  <span class="text-white-50 small font-monospace"><%= @product["barcode"].presence || "Barkod Yok" %></span>
                  <% if @product["gtip_code"].present? %>
                    <span class="text-white-50 small">|</span>
                    <span class="text-white-50 small fw-light px-2 bg-white bg-opacity-5 rounded">GTIP: <%= @product["gtip_code"] %></span>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2 app-header-actions">
              <%= home_nav_button(home_path, class_name: "app-header-icon-btn", icon: "home") %>
              <%= list_nav_button(products_path, class_name: "app-header-icon-btn", label: "Listeye Dön") %>
              <%= edit_record_button(edit_product_path(@product["id"]), class_name: "app-header-icon-btn", label: "Düzenle") %>
              
              <% if @product["deleted_at"].present? %>
                <%= link_to restore_product_path(@product["id"]), 
                      data: { turbo_method: :patch, turbo_confirm: "Geri yükle?", tip: "Geri Yükle" }, 
                      class: "btn app-header-icon-btn d-inline-flex align-items-center justify-content-center",
                      aria: { label: "Geri Yükle" } do %>
                  <span class="material-symbols-outlined">restore_from_trash</span>
                <% end %>
              <% else %>
                <%= link_to product_path(@product["id"]), 
                      data: { turbo_method: :delete, turbo_confirm: "Arşivle?", tip: "Arşivle" }, 
                      class: "btn app-header-icon-btn d-inline-flex align-items-center justify-content-center",
                      aria: { label: "Arşivle" } do %>
                  <span class="material-symbols-outlined">archive</span>
                <% end %>
              <% end %>
              
              <%= new_record_button("Yeni Ekle", new_product_path, class_name: "app-header-icon-btn") %>
            </div>
          </div>
        </div>
      </div>

      <!-- UNIFIED PRODUCT DETAILS CARD -->
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body p-0">
            <div class="row g-0">
              <!-- Info & Stock -->
              <div class="col-12 col-lg-3 border-end p-4">
                <h6 class="fw-bold text-secondary mb-3 d-flex align-items-center gap-2">
                  <span class="material-symbols-outlined fs-5">info</span> Detaylar
                </h6>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Kategori</span>
                  <span class="text-dark fw-medium text-end"><%= @product.dig("categories", "name").to_s.presence || @category_labels[@product["category_id"].to_s].presence || "-" %></span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Marka</span>
                  <span class="text-dark fw-medium text-end"><%= @product.dig("brands", "name").to_s.presence || @brand_labels[@product["brand_id"].to_s].presence || "-" %></span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Tip</span>
                  <span class="text-dark fw-medium"><%= @product["item_type"].to_s.upcase %></span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Birim</span>
                  <span class="text-dark fw-medium"><%= @product["unit"].to_s.upcase.presence || "-" %></span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <span class="small text-muted">GTIP Kodu</span>
                  <span class="text-dark fw-medium"><%= @product["gtip_code"].to_s.presence || "-" %></span>
                </div>

                <div class="border-top pt-3 d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Durum</span>
                  <% if @product["active"] %>
                    <span class="badge bg-success bg-opacity-10 text-success border-0 rounded-pill px-2">Aktif</span>
                  <% else %>
                    <span class="badge bg-danger bg-opacity-10 text-danger border-0 rounded-pill px-2">Pasif</span>
                  <% end %>
                </div>
                <% if @product["is_stock_item"].to_s.downcase.in?(%w[true 1 t]) %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Mevcut Stok</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary border-0 rounded-pill px-2"><%= @product["stock_quantity"].to_f.to_i %></span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Min. Stok</span>
                    <span class="badge bg-secondary bg-opacity-10 text-secondary border-0 rounded-pill px-2"><%= @product["min_stock_level"].to_f.to_i %></span>
                  </div>
                <% else %>
                  <div class="text-muted small fst-italic mt-2">Stok takibi kapalı</div>
                <% end %>
              </div>

              <!-- Pricing -->
              <div class="col-12 col-lg-3 border-end p-4">
                <h6 class="fw-bold text-secondary mb-3 d-flex align-items-center gap-2">
                  <span class="material-symbols-outlined fs-5">payments</span> Fiyatlandırma
                </h6>
                <div class="mb-4 bg-light rounded p-3">
                  <div class="small text-muted mb-1">Satış Fiyatı (<%= currency_name %>)</div>
                  <div class="h4 fw-bold text-dark mb-1"><%= number_to_currency(@product["price"], unit: price_unit, format: "%u%n") %></div>
                  <span class="badge <%= @product["sale_price_vat_included"] ? "bg-success-subtle text-success" : "bg-white text-muted border" %> fw-normal">
                    <%= @product["sale_price_vat_included"] ? "KDV Dahil" : "KDV Hariç" %>
                  </span>
                </div>
                <div class="mb-3">
                  <div class="small text-muted mb-1">Maliyet (<%= currency_name %>)</div>
                  <div class="h5 fw-bold text-dark mb-1"><%= number_to_currency(@product["cost_price"], unit: price_unit, format: "%u%n") %></div>
                  <span class="badge <%= @product["cost_price_vat_included"] ? "bg-success-subtle text-success" : "bg-light text-muted" %> border-0 fw-normal">
                    <%= @product["cost_price_vat_included"] ? "KDV Dahil" : "KDV Hariç" %>
                  </span>
                </div>
                <div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="small text-muted">KDV Oranı</span>
                    <span class="fw-bold text-dark">%<%= @product["vat_rate"].to_f.to_i %></span>
                  </div>
                </div>
              </div>

              <!-- Content/Description -->
              <div class="col-12 col-lg-3 border-end p-4">
                <h6 class="fw-bold text-secondary mb-3 d-flex align-items-center gap-2">
                  <span class="material-symbols-outlined fs-5">description</span> Açıklama
                </h6>
                <div class="text-dark small" style="white-space: pre-wrap; line-height: 1.6; max-height: 250px; overflow-y: auto;">
                  <%= @product["description"].to_s.presence || "Bu ürün için bir açıklama girilmemiş." %>
                </div>
              </div>

              <!-- Photos -->
              <div class="col-12 col-lg-3 p-4">
                <h6 class="fw-bold text-secondary mb-3 d-flex align-items-center gap-2">
                  <span class="material-symbols-outlined fs-5">imagesmode</span> Fotoğraflar
                </h6>
                <% if @product_images.present? %>
                  <div class="row g-2">
                    <% @product_images.first(4).each_with_index do |image, idx| %>
                      <% image_url = product_image_public_url(image["storage_path"]) %>
                      <div class="<%= idx == 0 ? 'col-12' : 'col-4' %>">
                        <a href="<%= image_url %>" target="_blank" rel="noopener" class="d-block border rounded overflow-hidden shadow-sm hover-scale transition">
                          <img src="<%= image_url %>" alt="Ürün" class="w-100" style="height: <%= idx == 0 ? '160px' : '65px' %>; object-fit: cover;" loading="lazy" />
                        </a>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="d-flex flex-column align-items-center justify-content-center p-4 bg-light rounded-3 text-muted h-75">
                    <span class="material-symbols-outlined fs-2 mb-2 opacity-50">no_photography</span>
                    <span class="small">Fotoğraf bulunmuyor</span>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DYNAMIC SECTION: STOCK OR OFFER MOVEMENTS -->
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <% is_stock_tracked = @product["is_stock_item"].to_s.downcase.in?(%w[true 1 t]) %>
          <div class="card-header bg-white border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
             <h6 class="fw-bold text-secondary mb-0 d-flex align-items-center gap-2">
               <% if is_stock_tracked %>
                 <span class="material-symbols-outlined fs-5">swap_horiz</span>
                 Stok Hareketleri
               <% else %>
                 <span class="material-symbols-outlined fs-5">history_edu</span>
                 Ürünün Dahil Olduğu Teklifler
               <% end %>
             </h6>
             <% unless is_stock_tracked %>
               <span class="badge bg-light text-muted border fw-normal">Teklif Hareketleri</span>
             <% end %>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              <% if is_stock_tracked %>
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-4 text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Tarih</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Hareket Tipi</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Belge Türü</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Belge No</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Miktar</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Birim Fiyat</th>
                      <th class="text-end pe-4 text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Aksiyon</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @stock_movements.present? %>
                      <% @stock_movements.each do |sm| %>
                        <tr>
                          <td class="ps-4 small"><%= sm[:date] %></td>
                          <td>
                            <% if sm[:quantity].to_i > 0 %>
                              <span class="badge bg-success bg-opacity-10 text-success border-0 px-2 rounded-pill"><i class="material-symbols-outlined fs-6 align-middle me-1" style="font-size: 14px;">arrow_downward</i>Giriş</span>
                            <% else %>
                              <span class="badge bg-danger bg-opacity-10 text-danger border-0 px-2 rounded-pill"><i class="material-symbols-outlined fs-6 align-middle me-1" style="font-size: 14px;">arrow_upward</i>Çıkış</span>
                            <% end %>
                          </td>
                          <td class="small"><%= sm[:document_type] %></td>
                          <td class="font-monospace text-muted small"><%= sm[:document_number] %></td>
                          <td>
                            <span class="fw-bold <%= sm[:quantity].to_i > 0 ? 'text-success' : 'text-danger' %>">
                              <%= sm[:quantity] > 0 ? "+#{sm[:quantity]}" : sm[:quantity] %> <%= @product['unit'].to_s.upcase %>
                            </span>
                          </td>
                          <td class="fw-semibold"><%= number_to_currency(sm[:price], unit: price_unit) %></td>
                          <td class="text-end pe-4">
                            <%= link_to sm[:document_url] || "#", class: "btn btn-sm btn-dark d-inline-flex align-items-center gap-1 rounded-pill px-3" do %>
                              Kayda Git <span class="material-symbols-outlined" style="font-size: 14px;">open_in_new</span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="7" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center text-muted py-4">
                            <span class="material-symbols-outlined fs-1 mb-2 opacity-25">inventory_2</span>
                            <h6 class="fw-bold mb-1">Stok Hareketi Bulunmuyor</h6>
                            <span class="small">Bu ürüne ait henüz bir stok girişi veya çıkışı yapılmamış.</span>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              <% else %>
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="ps-4 text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Müşteri</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Tarih</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Teklif No</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Teklif Fiyatı</th>
                      <th class="text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Durum</th>
                      <th class="text-end pe-4 text-secondary small fw-bold text-uppercase border-bottom-0" style="font-size: 0.7rem;">Aksiyon</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if @offer_movements.present? %>
                      <% @offer_movements.each do |om_entry| %>
                        <% 
                          # Ensure we are working with a Hash record
                          om = om_entry.is_a?(Array) ? om_entry.first : om_entry
                          next unless om.is_a?(Hash)

                          # Supabase relations can sometimes be returned as arrays even for 1-1 relationships
                          offer_data = om["offers"]
                          offer = offer_data.is_a?(Array) ? offer_data.first : offer_data
                          offer = {} unless offer.is_a?(Hash)

                          # Guard against missing offer ID to prevent routing errors
                          next if offer["id"].blank?

                          company_data = offer["companies"]
                          company = company_data.is_a?(Array) ? company_data.first : company_data
                          company = {} unless company.is_a?(Hash)

                          status = offer["status"].to_s.downcase
                          
                          status_badge, status_text = case status
                          when "accepted", "onaylandı", "approved", "onaylandi"
                            ["bg-success", "Onaylandı"]
                          when "rejected", "reddedildi", "reddildi"
                            ["bg-danger", "Reddedildi"]
                          when "sent", "gönderildi", "gonderildi"
                            ["bg-info", "Gönderildi"]
                          else
                            ["bg-warning text-dark", status.capitalize.presence || "Taslak"]
                          end
                        %>
                        <tr>
                          <td class="ps-4">
                            <div class="fw-bold text-primary"><%= company["name"] || "Bilinmeyen Müşteri" %></div>
                          </td>
                          <td class="small"><%= offer["offer_date"] || "-" %></td>
                          <td class="font-monospace text-muted small"><%= offer["offer_number"] || "-" %></td>
                          <td class="fw-bold text-dark"><%= number_to_currency(om["unit_price"], unit: price_unit) %></td>
                          <td>
                            <span class="badge <%= status_badge %> bg-opacity-10 text-<%= status_badge.split('-').last %> border-0 px-2 rounded-pill">
                              <%= status_text %>
                            </span>
                          </td>
                          <td class="text-end pe-4">
                            <%= link_to offer_path(offer["id"]), class: "btn btn-sm btn-outline-dark d-inline-flex align-items-center gap-1 rounded-pill px-3" do %>
                              Teklif Gözlem <span class="material-symbols-outlined" style="font-size: 14px;">visibility</span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    <% else %>
                      <tr>
                        <td colspan="6" class="text-center py-5">
                          <div class="d-flex flex-column align-items-center justify-content-center text-muted py-4">
                            <span class="material-symbols-outlined fs-1 mb-2 opacity-25">receipt_long</span>
                            <h6 class="fw-bold mb-1">Teklif Hareketi Bulunmuyor</h6>
                            <span class="small">Bu ürün henüz herhangi bir teklife dahil edilmemiş.</span>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="card shadow-sm border-0">
      <div class="card-body p-5 text-center">
        <span class="material-symbols-outlined fs-1 text-muted mb-3">inventory_2</span>
        <h4 class="fw-bold">Ürün bulunamadı</h4>
        <p class="text-secondary mb-4">Ulaşmaya çalıştığınız ürün kaydı mevcut değil.</p>
        <%= link_to "Ürün Listesine Dön", products_path, class: "btn btn-dark px-4" %>
      </div>
    </div>
  <% end %>

