<div class="row g-3">
    <div class="col-12">
      <div class="card shadow-sm app-header-card">
        <div class="card-body d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-3">
          <div>
            <h1 class="h4 mb-1">Ürün Listesi</h1>
            <p class="text-secondary mb-0">Toplam <strong><%= @products.size %></strong> Ürün</p>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2 app-header-actions">
            <%= filter_panel_toggle_button(class_name: "app-header-icon-btn") %>
            <%= new_record_button("Yeni Ürün", new_product_path, class_name: "app-header-icon-btn") %>
            <%= home_nav_button(home_path, class_name: "app-header-icon-btn", icon: "home") %>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 hidden" data-filter-panel>
      <div class="card shadow-sm">
        <div class="card-body">
          <%= form_with url: products_path, method: :get, local: true, class: app_form_class("filter-form") do |f| %>
            <div class="row g-2 align-items-end">
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :name, "Ürün", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.search_field :name, value: params[:name], placeholder: "Ürün Adı", class: "form-control form-control-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :barcode, "Barkod", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.search_field :barcode, value: params[:barcode], placeholder: "Barkod No", class: "form-control form-control-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :category, "Kategori", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.select :category, options_for_select([["Tümü", ""]] + @category_options, @category || params[:category]), {}, class: "form-select form-select-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :item_type, "Tip", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.select :item_type, options_for_select([["Tümü", ""]] + Products::UpsertForm::ITEM_TYPE_OPTIONS, params[:item_type]), {}, class: "form-select form-select-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :brand, "Marka", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.select :brand, options_for_select([["Tümü", ""]] + @brand_options, params[:brand]), {}, class: "form-select form-select-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg">
                <%= f.label :scope, "Kapsam", class: "form-label text-uppercase small fw-semibold text-secondary mb-1" %>
                <%= f.select :scope, options_for_select([["Aktif", "active"], ["Arşiv", "archived"], ["Tüm Kayıtlar", "all"]], @scope || params[:scope] || "active"), {}, class: "form-select form-select-sm", style: "width: 100%;" %>
              </div>
              <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                <div class="d-flex gap-2 w-100">
                  <%= f.submit "FİLTRELE", class: "btn btn-sm btn-dark flex-fill" %>
                  <%= link_to "TEMİZLE", products_path(per_page: @per_page), class: "btn btn-sm btn-warning flex-fill" %>
                  <%= f.hidden_field :per_page, value: @per_page %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <%= app_table_wrapper(class_name: "rt-products-table-wrap") do %>
            <table class="table table-hover align-middle mb-0 rt-table rt-pipeline-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Barkod</th>
                  <th>GTIP</th>
                  <th>Ürün</th>
                  <th>Kategori</th>
                  <th>Tip</th>
                  <th>Marka</th>      
                  <th>Birim</th>
                  <th>Stok</th>
                  <th>Döviz</th>
                  <th class="text-end">Fiyat</th>
                  <th class="text-end">KDV %</th>
                  <th class="rt-col-center">Durum</th>
                  <th class="rt-col-center">Aksiyon</th>
                </tr>
              </thead>
              <tbody>
                <% @products.each do |product| %>
                  <tr>
                    <td><%= product["sku"].to_s.presence || "-" %></td>
                    <td><%= product["barcode"].to_s.presence || "-" %></td>
                    <td><%= product["gtip_code"].to_s.presence || "-" %></td>
                    <td class="fw-semibold"><%= product["name"].to_s %></td>
                    <td><%= product.dig("categories", "name").to_s.presence || @category_labels[product["category_id"].to_s].presence || "-" %></td>
                    <td><%= product["item_type"].to_s.upcase %></td>  
                    <td><%= product.dig("brands", "name").to_s.presence || @brand_labels[product["brand_id"].to_s].presence || "-" %></td>                         
                    <td><%= product["unit"].to_s.upcase.presence || "-" %></td>
                    <td><%= product["is_stock_item"].to_s.downcase.in?(%w[true 1 t]) ? product["stock_quantity"].to_f.to_i : "-" %></td>
                    <td><%= (product.dig("currencies", "name") || @currency_labels[product["currency_id"].to_s]).to_s.presence || "Döviz Bilgisi Yok" %></td>
                    <td class="text-end"><%= number_to_currency(product["price"], unit: "#{(product.dig("currencies", "symbol") || @currency_symbols[product["currency_id"].to_s] || "TL ")} ", format: "%u%n") %></td>
                    <td class="text-end"><%= product["vat_rate"].to_f.to_i %></td>
                    <td class="rt-col-center">
                      <% if product["deleted_at"].present? %>
                        <span class="status-circle bg-danger text-white" title="Arşivde" aria-label="Arşivde">P</span>
                      <% elsif product["active"] %>
                        <span class="status-circle status-circle-success" title="Aktif" aria-label="Aktif">A</span>
                      <% else %>
                        <span class="status-circle status-circle-warn" title="Pasif" aria-label="Pasif">P</span>
                      <% end %>
                    </td>
                    <td class="rt-col-center rt-action-cell">
                      <details class="position-relative d-inline-block text-start rt-action-details">
                        <summary class="list-unstyled">
                          <span class="d-inline-flex align-items-center justify-content-center rounded border bg-white text-secondary" style="width:2.25rem;height:2.25rem;">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
                              <circle cx="5" cy="12" r="1.6"/>
                              <circle cx="12" cy="12" r="1.6"/>
                              <circle cx="19" cy="12" r="1.6"/>
                            </svg>
                          </span>
                        </summary>
                        <div class="rt-action-menu position-absolute end-0 mt-2 p-1 bg-white border rounded shadow-sm">
                          <%= link_to "Gözlem", product_path(product["id"]), class: "d-block rounded px-3 py-2 text-decoration-none text-body rt-arrow-hover" %>
                          <%= link_to "Düzenle", edit_product_path(product["id"]), class: "d-block rounded px-3 py-2 text-decoration-none text-body rt-arrow-hover" %>
                          <% if product["deleted_at"].present? %>
                            <%= link_to "Geri Yükle",
                                  restore_product_path(product["id"]),
                                  data: { turbo_method: :patch, turbo_confirm: "Bu ürünü geri yüklemek istiyor musunuz?" },
                                  class: "d-block rounded px-3 py-2 text-decoration-none text-success rt-arrow-hover" %>
                          <% else %>
                            <%= link_to "Arşivle",
                                  product_path(product["id"]),
                                  data: { turbo_method: :delete, turbo_confirm: "Bu ürünü arşivlemek istediğinize emin misiniz?" },
                                  class: "d-block rounded px-3 py-2 text-decoration-none text-danger rt-arrow-hover" %>
                          <% end %>
                        </div>
                      </details>
                    </td>
                  </tr>
                <% end %>
                <% if @products.empty? %>
                  <tr>
                    <td colspan="13" class="text-center py-5">
                      <div class="mx-auto" style="max-width: 420px;">
                        <div class="fw-semibold mb-1">Henüz kayıtlı ürün yok</div>
                        <div class="text-secondary">İlk ürününüzü eklemek için sağ üstteki butonu kullanın.</div>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div class="text-secondary">
            Sayfa <strong><%= @page %></strong> / <span><%= @per_page %> Kayıt</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="d-none d-sm-flex align-items-center gap-1">
              <span class="small text-secondary">Sayfa boyutu:</span>
              <% [25, 50, 100].each do |size| %>
                <% active = @per_page == size %>
                <%= link_to size.to_s, products_path(request.query_parameters.merge(page: 1, per_page: size)),
                      class: "btn btn-sm #{active ? 'btn-dark' : 'btn-outline-secondary'}" %>
              <% end %>
            </div>
            <% if @has_prev %>
              <%= link_to "Önceki", products_path(request.query_parameters.merge(page: @page - 1, per_page: @per_page)), class: "btn btn-outline-secondary" %>
            <% else %>
              <span class="btn btn-outline-secondary opacity-50" style="pointer-events:none">Önceki</span>
            <% end %>
            <% if @has_next %>
              <%= link_to "Sonraki", products_path(request.query_parameters.merge(page: @page + 1, per_page: @per_page)), class: "btn btn-outline-secondary" %>
            <% else %>
              <span class="btn btn-outline-secondary opacity-50" style="pointer-events:none">Sonraki</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbo:load", function () {
    var tableWrap = document.querySelector(".rt-products-table-wrap");
    if (!tableWrap) return;
    if (tableWrap.dataset.menuInit === "1") return;
    tableWrap.dataset.menuInit = "1";

    var actionMenus = function () {
      return Array.from(tableWrap.querySelectorAll("details.rt-action-details"));
    };

    tableWrap.addEventListener("click", function (event) {
      var clickedMenu = event.target.closest("details.rt-action-details");
      var clickedSummary = event.target.closest("details.rt-action-details > summary");

      if (!clickedMenu) {
        actionMenus().forEach(function (menu) {
          menu.open = false;
        });
        return;
      }

      if (clickedSummary) {
        actionMenus().forEach(function (menu) {
          if (menu !== clickedMenu) menu.open = false;
        });
      }
    });

    document.addEventListener("click", function (event) {
      if (tableWrap.contains(event.target)) return;
      actionMenus().forEach(function (menu) {
        menu.open = false;
      });
    });

    document.addEventListener("keydown", function (event) {
      if (event.key !== "Escape") return;
      actionMenus().forEach(function (menu) {
        menu.open = false;
      });
    });
  });
</script>



